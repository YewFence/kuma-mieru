name: Dependabot Auto Approve and Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if PR has automerge label
        id: check_label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name')

          if echo "$LABELS" | grep -q "automerge"; then
            echo "has_automerge=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Detected automerge label"
          else
            echo "has_automerge=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Automerge label not detected, skipping auto-merge"
          fi

      - name: Auto approve PR
        if: steps.check_label.outputs.has_automerge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve --body "‚úÖ Auto approved Dependabot dependency update"

      - name: Enable auto-merge with squash
        if: steps.check_label.outputs.has_automerge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto
          echo "üöÄ Enabled auto-merge (Squash and merge), waiting for all checks to pass before merging"
